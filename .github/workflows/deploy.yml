name: Deploy to Baota Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy VitePress to Baota Server

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build VitePress
        env:
          VITEPRESS_BASE: ${{ secrets.VITEPRESS_BASE || '/' }}
        run: |
          # 设置 VitePress base 路径
          DEPLOY_PATH=${VITEPRESS_BASE:-/}
          # 确保路径格式正确
          if [[ ! "$DEPLOY_PATH" =~ ^/ ]]; then
            DEPLOY_PATH="/$DEPLOY_PATH"
          fi
          if [[ ! "$DEPLOY_PATH" =~ /$ ]]; then
            DEPLOY_PATH="$DEPLOY_PATH/"
          fi
          export VITEPRESS_BASE="$DEPLOY_PATH"
          echo "Building with base path: $VITEPRESS_BASE"
          pnpm docs:build

      - name: Verify build output
        run: |
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "Build output not found!"
            exit 1
          fi
          echo "Build output verified: $(du -sh docs/.vitepress/dist)"
          ls -la docs/.vitepress/dist | head -10

      - name: Set deployment variables
        id: set-vars
        run: |
          SERVER_PORT="${{ secrets.SERVER_PORT }}"
          if [ -z "$SERVER_PORT" ]; then
            SERVER_PORT="22"
          fi
          echo "server_port=$SERVER_PORT" >> $GITHUB_OUTPUT

      - name: Analyze build output
        run: |
          echo "Build output analysis:"
          echo "Total files: $(find docs/.vitepress/dist -type f | wc -l)"
          echo "Total size: $(du -sh docs/.vitepress/dist | cut -f1)"
          echo "Largest files:"
          find docs/.vitepress/dist -type f -exec ls -lh {} \; | sort -k5 -hr | head -10

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test network speed
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || 22 }}
        run: |
          echo "Testing network connection to server..."
          time ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -p $SERVER_PORT \
              -o ConnectTimeout=10 \
              $SERVER_USER@$SERVER_HOST \
              "echo 'Connection test successful'"
          
          echo "Testing server location and network..."
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -p $SERVER_PORT \
              $SERVER_USER@$SERVER_HOST \
              "curl -s ifconfig.me && echo '' && ping -c 3 8.8.8.8 | tail -1" || echo "Network test failed"

      - name: Incremental deploy to server (only changed files)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || 22 }}
          SERVER_DEPLOY_PATH: ${{ secrets.SERVER_DEPLOY_PATH || '/www/wwwroot/ncu-notes-sharing-wiki' }}
        run: |
          echo "Starting incremental deployment at $(date)..."
          echo "Source: docs/.vitepress/dist"
          echo "Target: $SERVER_DEPLOY_PATH"
          
          # 统计要传输的文件
          echo "Analyzing files to transfer..."
          FILE_COUNT=$(find docs/.vitepress/dist -type f | wc -l)
          TOTAL_SIZE=$(du -sh docs/.vitepress/dist | cut -f1)
          echo "Total files: $FILE_COUNT, Total size: $TOTAL_SIZE"
          
          # 确保目标目录存在并有写权限
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -p $SERVER_PORT \
              $SERVER_USER@$SERVER_HOST \
              "mkdir -p $SERVER_DEPLOY_PATH && chmod 755 $SERVER_DEPLOY_PATH"
          
          # 使用 rsync 进行增量同步
          # --delete: 删除目标目录中源目录不存在的文件
          # --checksum: 使用校验和而不是时间戳来判断文件是否变更（更准确）
          # --progress: 显示传输进度
          # --partial: 支持断点续传
          # --partial-dir: 部分传输文件的临时目录
          # --no-owner --no-group: 不保留所有者信息（避免权限问题）
          # --chmod: 设置文件权限
          rsync -avz --progress --delete \
              --checksum \
              --partial \
              --partial-dir=.rsync-partial \
              --no-owner \
              --no-group \
              --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r \
              --timeout=600 \
              --bwlimit=0 \
              --ignore-errors \
              -e "ssh -i ~/.ssh/deploy_key \
                  -o StrictHostKeyChecking=no \
                  -o UserKnownHostsFile=~/.ssh/known_hosts \
                  -p $SERVER_PORT \
                  -o ConnectTimeout=30 \
                  -o Compression=yes \
                  -o Cipher=aes128-gcm@openssh.com \
                  -o MACs=umac-128-etm@openssh.com \
                  -o ServerAliveInterval=15 \
                  -o ServerAliveCountMax=10 \
                  -o TCPKeepAlive=yes" \
              docs/.vitepress/dist/ \
              $SERVER_USER@$SERVER_HOST:$SERVER_DEPLOY_PATH/ || {
              echo "⚠️ rsync completed with warnings, but continuing..."
              EXIT_CODE=$?
              if [ $EXIT_CODE -eq 23 ]; then
                echo "Some files had issues, but this is often non-critical"
              fi
            }
          
          echo "✅ Incremental deployment completed at $(date)"
          
          # 验证部署结果
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -p $SERVER_PORT \
              $SERVER_USER@$SERVER_HOST \
              "echo 'Deployed files:' && ls -lh $SERVER_DEPLOY_PATH | head -10 && echo '...' && echo 'Total files:' && find $SERVER_DEPLOY_PATH -type f 2>/dev/null | wc -l"

      - name: Set file permissions
        env:
          SERVER_DEPLOY_PATH: ${{ secrets.SERVER_DEPLOY_PATH || '/www/wwwroot/ncu-notes-sharing-wiki' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ steps.set-vars.outputs.server_port }}
          script: |
            DEPLOY_PATH="${SERVER_DEPLOY_PATH:-/www/wwwroot/ncu-notes-sharing-wiki}"
            
            # 设置文件权限（宝塔默认使用 www:www）
            echo "Setting file permissions..."
            chown -R www:www "$DEPLOY_PATH"
            find "$DEPLOY_PATH" -type d -exec chmod 755 {} \;
            find "$DEPLOY_PATH" -type f -exec chmod 644 {} \;
            
            echo "✅ Permissions set successfully!"
            echo "Deployment summary:"
            echo "  Total files: $(find $DEPLOY_PATH -type f | wc -l)"
            echo "  Total size: $(du -sh $DEPLOY_PATH | cut -f1)"


name: Deploy to Baota Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy VitePress to Baota Server

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build VitePress
        env:
          VITEPRESS_BASE: ${{ secrets.VITEPRESS_BASE || '/' }}
        run: |
          # 设置 VitePress base 路径
          DEPLOY_PATH=${VITEPRESS_BASE:-/}
          # 确保路径格式正确
          if [[ ! "$DEPLOY_PATH" =~ ^/ ]]; then
            DEPLOY_PATH="/$DEPLOY_PATH"
          fi
          if [[ ! "$DEPLOY_PATH" =~ /$ ]]; then
            DEPLOY_PATH="$DEPLOY_PATH/"
          fi
          export VITEPRESS_BASE="$DEPLOY_PATH"
          echo "Building with base path: $VITEPRESS_BASE"
          pnpm docs:build

      - name: Verify build output
        run: |
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "Build output not found!"
            exit 1
          fi
          echo "Build output verified: $(du -sh docs/.vitepress/dist)"
          ls -la docs/.vitepress/dist | head -10

      - name: Set deployment variables
        id: set-vars
        run: |
          SERVER_PORT="${{ secrets.SERVER_PORT }}"
          if [ -z "$SERVER_PORT" ]; then
            SERVER_PORT="22"
          fi
          echo "server_port=$SERVER_PORT" >> $GITHUB_OUTPUT

      - name: Deploy to server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ steps.set-vars.outputs.server_port }}
          source: "docs/.vitepress/dist"
          target: /tmp
          rm: true

      - name: Move files and set permissions
        env:
          SERVER_DEPLOY_PATH: ${{ secrets.SERVER_DEPLOY_PATH }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ steps.set-vars.outputs.server_port }}
          script: |
            DEPLOY_PATH="${SERVER_DEPLOY_PATH:-/www/wwwroot/ncu-notes-sharing-wiki}"
            echo "Deploy path: $DEPLOY_PATH"
            
            # 查找上传的文件位置
            echo "Checking /tmp directory:"
            ls -la /tmp | head -20
            
            # 尝试多个可能的路径
            SOURCE_DIR=""
            if [ -d "/tmp/dist" ]; then
              SOURCE_DIR="/tmp/dist"
            elif [ -d "/tmp/docs/.vitepress/dist" ]; then
              SOURCE_DIR="/tmp/docs/.vitepress/dist"
            elif [ -d "/tmp/.vitepress/dist" ]; then
              SOURCE_DIR="/tmp/.vitepress/dist"
            else
              # 查找包含 index.html 的目录
              SOURCE_DIR=$(find /tmp -name "index.html" -type f 2>/dev/null | head -1 | xargs dirname)
            fi
            
            if [ -n "$SOURCE_DIR" ] && [ -d "$SOURCE_DIR" ]; then
              echo "Found source directory: $SOURCE_DIR"
              ls -la "$SOURCE_DIR" | head -10
              
              # 创建部署目录（如果不存在）
              mkdir -p "$DEPLOY_PATH"
              
              # 清空部署目录（保留隐藏文件）
              find "$DEPLOY_PATH" -mindepth 1 -maxdepth 1 ! -name '.*' -exec rm -rf {} +
              
              # 复制文件从源目录到部署目录
              cp -r "$SOURCE_DIR"/* "$DEPLOY_PATH"/
              
              # 清理临时文件
              rm -rf /tmp/dist /tmp/docs 2>/dev/null || true
              
              # 设置文件权限（宝塔默认使用 www:www）
              chown -R www:www "$DEPLOY_PATH"
              chmod -R 755 "$DEPLOY_PATH"
              
              echo "Files in deploy directory:"
              ls -la "$DEPLOY_PATH" | head -10
              echo "✅ Deployment completed!"
            else
              echo "❌ Error: Source directory not found!"
              echo "Searching for index.html in /tmp:"
              find /tmp -name "index.html" 2>/dev/null || echo "No index.html found"
              exit 1
            fi


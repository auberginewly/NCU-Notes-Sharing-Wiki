name: Deploy to Tencent CloudBase

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy VitePress to CloudBase
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build VitePress
        run: pnpm docs:build
      
      - name: Verify build output
        run: |
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "Build output not found!"
            exit 1
          fi
          echo "Build output verified: $(du -sh docs/.vitepress/dist)"
      
      - name: List build output files
        run: |
          echo "Build output structure:"
          find docs/.vitepress/dist -type f | head -20
          echo "Total files: $(find docs/.vitepress/dist -type f | wc -l)"
      
      - name: Deploy to Tencent CloudBase
        id: deploy
        uses: TencentCloudBase/cloudbase-action@v2.0.1
        with:
          secretId: ${{ secrets.CLOUDBASE_SECRET_ID }}
          secretKey: ${{ secrets.CLOUDBASE_SECRET_KEY }}
          envId: ${{ secrets.CLOUDBASE_ENV_ID }}
      
      - name: Deployment result
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed. Check logs above for details."
            echo "Note: Font file errors (Slant.flf) are usually harmless."
          fi


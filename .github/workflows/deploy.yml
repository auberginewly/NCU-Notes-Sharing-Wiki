name: Deploy to Tencent CloudBase

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy VitePress to CloudBase
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build VitePress
        env:
          TCB_DEPLOY_PATH: ${{ secrets.TCB_DEPLOY_PATH }}
        run: |
          # 设置 VitePress base 路径，与部署路径保持一致
          DEPLOY_PATH=${TCB_DEPLOY_PATH:-/ncu-notes-sharing-wiki}
          # 确保路径以 / 开头和结尾
          if [[ ! "$DEPLOY_PATH" =~ ^/ ]]; then
            DEPLOY_PATH="/$DEPLOY_PATH"
          fi
          if [[ ! "$DEPLOY_PATH" =~ /$ ]]; then
            DEPLOY_PATH="$DEPLOY_PATH/"
          fi
          export VITEPRESS_BASE="$DEPLOY_PATH"
          echo "Building with base path: $VITEPRESS_BASE"
          pnpm docs:build
      
      - name: Verify build output
        run: |
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "Build output not found!"
            exit 1
          fi
          echo "Build output verified: $(du -sh docs/.vitepress/dist)"
      
      - name: List build output files
        run: |
          echo "Build output structure:"
          find docs/.vitepress/dist -type f | head -20
          echo "Total files: $(find docs/.vitepress/dist -type f | wc -l)"
      
      - name: Install CloudBase CLI
        run: npm install -g @cloudbase/cli
      
      - name: Login to CloudBase
        run: |
          tcb login --apiKeyId ${{ secrets.TCB_SECRET_ID }} --apiKey ${{ secrets.TCB_SECRET_KEY }}
      
      - name: Deploy to CloudBase Static Hosting
        env:
          TCB_DEPLOY_PATH: ${{ secrets.TCB_DEPLOY_PATH }}
        run: |
          # 部署路径：可以通过 Secret 配置，默认为 /ncu-notes-sharing-wiki
          DEPLOY_PATH=${TCB_DEPLOY_PATH:-/ncu-notes-sharing-wiki}
          echo "Deploying to path: $DEPLOY_PATH"
          
          # 重试机制：最多重试 3 次
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if tcb hosting deploy ./docs/.vitepress/dist $DEPLOY_PATH -e ${{ secrets.TCB_ENV_ID }}; then
              echo "✅ Deployment successful!"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ Deployment failed, retrying... ($RETRY_COUNT/$MAX_RETRIES)"
                sleep 5
              else
                echo "❌ Deployment failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
      


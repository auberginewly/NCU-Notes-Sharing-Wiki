name: Deploy to Tencent CloudBase

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy VitePress to CloudBase
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Build VitePress
        run: pnpm docs:build
      
      - name: Verify build output
        run: |
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "Build output not found!"
            exit 1
          fi
          echo "Build output verified: $(du -sh docs/.vitepress/dist)"
      
      - name: List build output files
        run: |
          echo "Build output structure:"
          find docs/.vitepress/dist -type f | head -20
          echo "Total files: $(find docs/.vitepress/dist -type f | wc -l)"
      
      - name: Install CloudBase CLI
        run: npm install -g @cloudbase/cli
      
      - name: Login to CloudBase
        run: |
          tcb login --apiKeyId ${{ secrets.TCB_SECRET_ID }} --apiKey ${{ secrets.TCB_SECRET_KEY }}
      
      - name: Deploy to CloudBase Static Hosting
        run: |
          tcb hosting deploy ./docs/.vitepress/dist / -e ${{ secrets.TCB_ENV_ID }}
      
      - name: Deployment success
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "Your site should be available at the CloudBase static hosting URL."


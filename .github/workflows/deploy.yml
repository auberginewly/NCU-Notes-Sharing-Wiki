name: Deploy to Baota Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy VitePress to Baota Server

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build VitePress
        env:
          VITEPRESS_BASE: ${{ secrets.VITEPRESS_BASE || '/' }}
        run: |
          # 设置 VitePress base 路径
          DEPLOY_PATH=${VITEPRESS_BASE:-/}
          # 确保路径格式正确
          if [[ ! "$DEPLOY_PATH" =~ ^/ ]]; then
            DEPLOY_PATH="/$DEPLOY_PATH"
          fi
          if [[ ! "$DEPLOY_PATH" =~ /$ ]]; then
            DEPLOY_PATH="$DEPLOY_PATH/"
          fi
          export VITEPRESS_BASE="$DEPLOY_PATH"
          echo "Building with base path: $VITEPRESS_BASE"
          pnpm docs:build

      - name: Verify build output
        run: |
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "Build output not found!"
            exit 1
          fi
          echo "Build output verified: $(du -sh docs/.vitepress/dist)"
          ls -la docs/.vitepress/dist | head -10

      - name: Set deployment variables
        id: set-vars
        run: |
          SERVER_PORT="${{ secrets.SERVER_PORT }}"
          if [ -z "$SERVER_PORT" ]; then
            SERVER_PORT="22"
          fi
          echo "server_port=$SERVER_PORT" >> $GITHUB_OUTPUT

      - name: Compress build output (optimized)
        run: |
          cd docs/.vitepress
          # 使用 xz 压缩（压缩率更高，但需要先安装）
          # 如果没有 xz，使用 gzip 的最高压缩级别
          if command -v xz &> /dev/null; then
            tar -cJf dist.tar.xz dist
            echo "Compressed size (xz): $(du -sh dist.tar.xz)"
            ls -lh dist.tar.xz
            COMPRESSED_FILE="dist.tar.xz"
          else
            # 使用 gzip 最高压缩级别 (-9)
            tar -czf dist.tar.gz dist --use-compress-program="gzip -9"
            echo "Compressed size (gzip -9): $(du -sh dist.tar.gz)"
            ls -lh dist.tar.gz
            COMPRESSED_FILE="dist.tar.gz"
          fi
          echo "COMPRESSED_FILE=$COMPRESSED_FILE" >> $GITHUB_ENV

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to server via SSH (with progress)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT || 22 }}
        run: |
          COMPRESSED_FILE="${COMPRESSED_FILE:-dist.tar.gz}"
          FILE_PATH="docs/.vitepress/$COMPRESSED_FILE"
          
          echo "File size: $(du -sh $FILE_PATH)"
          echo "Starting transfer at $(date)..."
          
          # 使用 rsync 传输，添加带宽限制和超时设置
          # -z: 压缩传输数据
          # --partial: 支持断点续传
          # --inplace: 直接覆盖，节省空间
          rsync -avz --progress --partial --inplace \
              --timeout=300 \
              -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -p $SERVER_PORT -o ConnectTimeout=30 -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes" \
              $FILE_PATH \
              $SERVER_USER@$SERVER_HOST:/tmp/$COMPRESSED_FILE
          
          echo "✅ Transfer completed at $(date)"
          
          # 验证文件是否传输成功
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -p $SERVER_PORT \
              $SERVER_USER@$SERVER_HOST \
              "ls -lh /tmp/$COMPRESSED_FILE && echo 'File exists on server'"

      - name: Extract and deploy files
        env:
          SERVER_DEPLOY_PATH: ${{ secrets.SERVER_DEPLOY_PATH }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ steps.set-vars.outputs.server_port }}
          script: |
            DEPLOY_PATH="${SERVER_DEPLOY_PATH:-/www/wwwroot/ncu-notes-sharing-wiki}"
            echo "Deploy path: $DEPLOY_PATH"
            
            # 检查压缩包是否存在（支持 .gz 和 .xz）
            COMPRESSED_FILE=""
            if [ -f "/tmp/dist.tar.xz" ]; then
              COMPRESSED_FILE="/tmp/dist.tar.xz"
              EXTRACT_CMD="tar -xJf"
            elif [ -f "/tmp/dist.tar.gz" ]; then
              COMPRESSED_FILE="/tmp/dist.tar.gz"
              EXTRACT_CMD="tar -xzf"
            else
              echo "❌ Error: dist.tar.gz or dist.tar.xz not found in /tmp"
              ls -la /tmp | grep -E "dist|tar"
              exit 1
            fi
            
            echo "Found compressed file: $COMPRESSED_FILE"
            echo "Size: $(du -sh $COMPRESSED_FILE)"
            
            # 创建临时解压目录
            TEMP_DIR="/tmp/vitepress_deploy_$$"
            mkdir -p "$TEMP_DIR"
            
            # 解压文件
            echo "Extracting files..."
            $EXTRACT_CMD $COMPRESSED_FILE -C "$TEMP_DIR"
            
            # 检查解压结果
            if [ ! -d "$TEMP_DIR/dist" ]; then
              echo "❌ Error: dist directory not found after extraction"
              ls -la "$TEMP_DIR"
              exit 1
            fi
            
            echo "Extraction successful. Files in dist:"
            ls -la "$TEMP_DIR/dist" | head -10
            
            # 创建部署目录（如果不存在）
            mkdir -p "$DEPLOY_PATH"
            
            # 清空部署目录（保留隐藏文件）
            find "$DEPLOY_PATH" -mindepth 1 -maxdepth 1 ! -name '.*' -exec rm -rf {} +
            
            # 复制文件从解压目录到部署目录
            echo "Copying files to deploy directory..."
            cp -r "$TEMP_DIR/dist"/* "$DEPLOY_PATH"/
            
            # 清理临时文件
            rm -rf "$TEMP_DIR" /tmp/dist.tar.gz /tmp/dist.tar.xz
            
            # 设置文件权限（宝塔默认使用 www:www）
            chown -R www:www "$DEPLOY_PATH"
            chmod -R 755 "$DEPLOY_PATH"
            
            echo "Files in deploy directory:"
            ls -la "$DEPLOY_PATH" | head -10
            echo "✅ Deployment completed!"

